# Import libraries
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import OneHotEncoder, StandardScaler
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import matplotlib.pyplot as plt
import seaborn as sns
import joblib
import os

# 1. Load the dataset
data_path = '/content/vehicle_price_prediction/vehicles.csv'  # change path if needed
data = pd.read_csv(data_path)
print("Data loaded successfully")
print("Shape of data:", data.shape)
print(data.head())

# 2. Choose target column
target = 'price'  # change this if your target column has a different name
if target not in data.columns:
    print("Columns available:", data.columns)
    raise SystemExit("Please set the correct target column name")

# Remove rows with missing price values
data = data[data[target].notna()]

# Select feature columns
feature_cols = [c for c in data.columns if c != target and c not in ['model', 'variant']]
X = data[feature_cols]
y = data[target]

# 3. Split data into train and test sets
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)
print("Data split complete")

# 4. Separate numeric and categorical columns
num_cols = X.select_dtypes(include=['int64', 'float64']).columns.tolist()
cat_cols = X.select_dtypes(include=['object', 'category']).columns.tolist()

# 5. Create preprocessing steps
num_transformer = Pipeline(steps=[
    ('scaler', StandardScaler())
])
cat_transformer = Pipeline(steps=[
    ('onehot', OneHotEncoder(handle_unknown='ignore', sparse_output=False))
])

preprocessor = ColumnTransformer(transformers=[
    ('num', num_transformer, num_cols),
    ('cat', cat_transformer, cat_cols)
])

# 6. Create pipeline with preprocessing and model
model = Pipeline(steps=[
    ('preprocessor', preprocessor),
    ('rf', RandomForestRegressor(n_estimators=200, random_state=42, n_jobs=-1))
])

# 7. Train the model
model.fit(X_train, y_train)
print("Model training completed")

# 8. Test and evaluate
y_pred = model.predict(X_test)
mae = mean_absolute_error(y_test, y_pred)
rmse = np.sqrt(mean_squared_error(y_test, y_pred))
r2 = r2_score(y_test, y_pred)

print("Mean Absolute Error:", mae)
print("Root Mean Squared Error:", rmse)
print("R2 Score:", r2)

# 9. Plot actual vs predicted
plt.scatter(y_test, y_pred, alpha=0.4)
plt.xlabel('Actual Price')
plt.ylabel('Predicted Price')
plt.title('Actual vs Predicted Vehicle Prices')
plt.show()

# 10. Save the model
output_folder = '/content/vehicle_price_prediction/output'
os.makedirs(output_folder, exist_ok=True)
joblib.dump(model, f'{output_folder}/vehicle_price_model.joblib')
print("Model saved successfully in:", output_folder)
